@using KOICommunicationPlatform.Models.ViewModels
@model KOICommunicationPlatform.Models.ViewModels.SprintViewModel

<section>
<div class="content task-board-section" id="tasksContainer">
    @if (Model != null)
    {
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card card">
                        <div class="card-header">
                            <button type="button" class="btn btn-primary float-right" data-toggle="modal" data-target="#createTaskModal" style="background-color:green;border-color:green"> + Create Task</button>
                        </div>
                        <div class="lanes card-body">
                            <div class="row">
                                <!-- Backlog Lane -->
                                <div class="col-sm-3">
                                    <div class="swim-lane card card-row card-secondary" id="backlog-lane">
                                        <div class="card-header bg-warning">
                                            <h3 class="card-title" style="color:#FFFFFF">Backlog</h3>
                                        </div>
                                        <div class="card-body" draggable="true">
                                            <!-- Dynamically adding tasks to Backlog Lane -->
                                            @if (Model.GroupedTasks.ContainsKey("Backlog"))
                                            {
                                                foreach (var task in Model.GroupedTasks["Backlog"])
                                                {
                                                    <div class="card card-warning card-outline">
                                                        <div class="card-header">
                                                            <h5 class="card-title" style="color:black;font-weight:bold">@task.TaskName</h5>
                                                            <div class="card-tools">
                                                                <button type="button" class="btn btn-primary btn-sm ml-2" onclick="openCommentModal(@task.Id)">
                                                                    <i class="fas fa-comment"></i>
                                                                    <span id="commentCount_@task.Id" style="display:inline;">0</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task Start Date: </p>
                                                                <p>@task.StartDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task End Date: </p>
                                                                <p>@task.EndDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Description:</p>
                                                            <p>@task.Description</p>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Priority:</p>
                                                                <p style="color:@(task.Priority == "High" ? "red" : task.Priority == "Medium" ? "orange" : "green"); font-weight:bold">
                                                                    @task.Priority.Substring(0, 1)
                                                                </p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Allocated Student Details:</p>
                                                            <ul>
                                                                @foreach (var student in Model.AssignedStudents.GetValueOrDefault(task.Id, new List<StudentGroupViewModel>()))
                                                                {
                                                                    <li>@student.GivenName @student.Surname - @student.StudentId</li>
                                                                }
                                                            </ul>
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <div class="form-group">
                                                                        <div class="custom-control custom-checkbox">
                                                                            <input class="custom-control-input" type="checkbox" id="customCheckbox1" checked="">
                                                                            @* <label for="customCheckbox1" class="custom-control-label">@task.AssignmentCode</label> *@
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-sm-6">
                                                                    <div class="row no-print">
                                                                        <div class="col-12">
                                                                            <button type="button" class="btn btn float-right" style="background-color:#29f30d87;color:black;font-weight:bold" onclick="editTask('@task.Id', '@task.SprintId')"> Edit</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>

                                </div>
                                <!-- To Do Lane -->
                                <div class="col-sm-3">
                                    <div class="swim-lane card card-row card-danger" id="todo-lane">
                                        <div class="card-header">
                                            <h3 class="card-title" style="color:#FFFFFF">ToDo</h3>
                                        </div>
                                        <div class="card-body" draggable="true">
                                            <!-- Dynamically adding tasks to Backlog Lane -->
                                            @if (Model.GroupedTasks.ContainsKey("ToDo"))
                                            {
                                                foreach (var task in Model.GroupedTasks["ToDo"])
                                                {
                                                    <div class="card card-warning card-outline">
                                                        <div class="card-header">
                                                            <h5 class="card-title" style="color:black;font-weight:bold">@task.TaskName</h5>
                                                            <div class="card-tools">
                                                                <button type="button" class="btn btn-primary btn-sm ml-2" onclick="openCommentModal(@task.Id)">
                                                                    <span id="commentCount_@task.Id" style="display:inline;">0</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task Start Date: </p>
                                                                <p>@task.StartDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task End Date: </p>
                                                                <p>@task.EndDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Description:</p>
                                                            <p>@task.Description</p>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Priority:</p>
                                                                <p style="color:@(task.Priority == "High" ? "red" : task.Priority == "Medium" ? "orange" : "green"); font-weight:bold">
                                                                    @task.Priority.Substring(0, 1)
                                                                </p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Allocated Student Details:</p>
                                                            <ul>
                                                                @foreach (var student in Model.AssignedStudents.GetValueOrDefault(task.Id, new List<StudentGroupViewModel>()))
                                                                {
                                                                    <li>@student.GivenName @student.Surname - @student.StudentId</li>
                                                                }
                                                            </ul>
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <div class="form-group">
                                                                        <div class="custom-control custom-checkbox">
                                                                            <input class="custom-control-input" type="checkbox" id="customCheckbox1" checked="">
                                                                            @* <label for="customCheckbox1" class="custom-control-label">@task.AssignmentCode</label> *@
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-sm-6">
                                                                    <div class="row no-print">
                                                                        <div class="col-12">
                                                                            <button type="button" class="btn btn float-right" style="background-color:#29f30d87;color:black;font-weight:bold" onclick="editTask('@task.Id', '@task.SprintId')"> Edit</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                                <!-- In Progress Lane -->
                                <div class="col-sm-3">
                                    <div class="swim-lane card card-row card-default" id="inprogress-lane">
                                        <div class="card-header bg-info">
                                            <h3 class="card-title">InProgress</h3>
                                        </div>
                                        <div class="card-body" draggable="true">
                                            <!-- Dynamically adding tasks to Backlog Lane -->
                                            @if (Model.GroupedTasks.ContainsKey("InProgress"))
                                            {
                                                foreach (var task in Model.GroupedTasks["InProgress"])
                                                {
                                                    <div class="card card-warning card-outline">
                                                        <div class="card-header">
                                                            <h5 class="card-title" style="color:black;font-weight:bold">@task.TaskName</h5>
                                                            <div class="card-tools">
                                                                <button type="button" class="btn btn-primary btn-sm ml-2" onclick="openCommentModal(@task.Id)">
                                                                    <span id="commentCount_@task.Id" style="display:inline;">0</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task Start Date: </p>
                                                                <p>@task.StartDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task End Date: </p>
                                                                <p>@task.EndDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Description:</p>
                                                            <p>@task.Description</p>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Priority:</p>
                                                                <p style="color:@(task.Priority == "High" ? "red" : task.Priority == "Medium" ? "orange" : "green"); font-weight:bold">
                                                                    @task.Priority.Substring(0, 1)
                                                                </p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Allocated Student Details:</p>
                                                            <ul>
                                                                @foreach (var student in Model.AssignedStudents.GetValueOrDefault(task.Id, new List<StudentGroupViewModel>()))
                                                                {
                                                                    <li>@student.GivenName @student.Surname - @student.StudentId</li>
                                                                }
                                                            </ul>
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <div class="form-group">
                                                                        <div class="custom-control custom-checkbox">
                                                                            <input class="custom-control-input" type="checkbox" id="customCheckbox1" checked="">
                                                                            @* <label for="customCheckbox1" class="custom-control-label">@task.AssignmentCode</label> *@
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-sm-6">
                                                                    <div class="row no-print">
                                                                        <div class="col-12">
                                                                            <button type="button" class="btn btn float-right" style="background-color:#29f30d87;color:black;font-weight:bold" onclick="editTask('@task.Id', '@task.SprintId')"> Edit</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                                <!-- Done Lane -->
                                <div class="col-sm-3">
                                    <div class="swim-lane card card-row card-success" id="done-lane">
                                        <div class="card-header">
                                            <h3 class="card-title">Done</h3>
                                        </div>
                                        <div class="card-body" draggable="true">
                                            <!-- Dynamically adding tasks to Backlog Lane -->
                                            @if (Model.GroupedTasks.ContainsKey("Done"))
                                            {
                                                foreach (var task in Model.GroupedTasks["Done"])
                                                {
                                                    <div class="card card-warning card-outline">
                                                        <div class="card-header">
                                                            <h5 class="card-title" style="color:black;font-weight:bold">@task.TaskName</h5>
                                                            <div class="card-tools">
                                                                <button type="button" class="btn btn-primary btn-sm ml-2" onclick="openCommentModal(@task.Id)">
                                                                    <span id="commentCount_@task.Id" style="display:inline;">0</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="card-body">
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task Start Date: </p>
                                                                <p>@task.StartDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Task End Date: </p>
                                                                <p>@task.EndDate.ToString("dd/MMM/yyyy hh:mmtt")</p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Description:</p>
                                                            <p>@task.Description</p>
                                                            <div style="display:flex; align-items:center">
                                                                <p style="color:black;font-weight:bold; margin-right:5px">Priority:</p>
                                                                <p style="color:@(task.Priority == "High" ? "red" : task.Priority == "Medium" ? "orange" : "green"); font-weight:bold">
                                                                    @task.Priority.Substring(0, 1)
                                                                </p>
                                                            </div>
                                                            <p style="color:black;font-weight:bold; margin-right:5px">Allocated Student Details:</p>
                                                            <ul>
                                                                @foreach (var student in Model.AssignedStudents.GetValueOrDefault(task.Id, new List<StudentGroupViewModel>()))
                                                                {
                                                                    <li>@student.GivenName @student.Surname - @student.StudentId</li>
                                                                }
                                                            </ul>
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <div class="form-group">
                                                                        <div class="custom-control custom-checkbox">
                                                                            <input class="custom-control-input" type="checkbox" id="customCheckbox1" checked="">
                                                                            @* <label for="customCheckbox1" class="custom-control-label">@task.AssignmentCode</label> *@
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-sm-6">
                                                                    <div class="row no-print">
                                                                        <div class="col-12">
                                                                            <button type="button" class="btn btn float-right" style="background-color:#29f30d87;color:black;font-weight:bold" onclick="editTask('@task.Id', '@task.SprintId')"> Edit</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <p>No tasks available for the selected sprint.</p>
    }
</div>
</section>
<!-- Modal -->
<div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog custom-modal-size" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">Comments</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newComment">Add New Comment</label>
                    <textarea class="form-control" id="newComment" rows="3"></textarea>
                </div>
                <button type="button" class="btn btn-success" onclick="addComment()">Add Comment</button>

                <hr />

                <h5>Previous Comments</h5>
                <div id="previousComments">
                    <!-- Previous comments will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">

        $(document).ready(function () {
            @foreach (var task in Model.GroupedTasks["Backlog"])
            {
                <text>loadPreviousComments(@task.Id);</text>
                ;
            }
            @foreach (var task in Model.GroupedTasks["ToDo"])
            {
                <text>loadPreviousComments(@task.Id);</text>
                ;
            }
            @foreach (var task in Model.GroupedTasks["InProgress"])
            {
                <text>loadPreviousComments(@task.Id);</text>
                ;
            }
            @foreach (var task in Model.GroupedTasks["Done"])
            {
                <text>loadPreviousComments(@task.Id);</text>
            }
        });

        var currentTaskId;

        function openCommentModal(taskId) {
            currentTaskId = taskId; // Make sure this is set correctly
            $('#newComment').val(''); // Clear the textarea
            loadPreviousComments(taskId); // Load previous comments
            $('#commentModal').modal('show'); // Show the modal
        }

        function loadPreviousComments(taskId) {
            $.ajax({
                url: '@Url.Action("GetComments", "StudentTaskTracking")', // Adjust the controller name and action as needed
                type: 'GET',
                data: { taskId: taskId },
                success: function (response) {
                    var commentsHtml = '';
                    response.forEach(function (comment) {
                        commentsHtml += '<div class="comment">';
                        commentsHtml += '<p><strong>' + comment.createdBy + ':</strong> ' + comment.comment + '</p>';
                        commentsHtml += '<p><small>' + comment.createdDateTime + '</small></p>';
                        commentsHtml += '</div>';
                        commentsHtml += '<hr />';
                    });
                    $('#previousComments').html(commentsHtml);
                    // Update the comment count
                    var commentCount = response.length;
                    $('#commentCount_' + taskId).text(commentCount);  // Update the specific
                },
                error: function () {
                    alert('Failed to load comments.');
                }
            });
        }

        function addComment() {
            var commentText = $('#newComment').val();
            if (commentText.trim() === '') {
                alert('Comment cannot be empty.');
                return;
            }

            $.ajax({
                url: '@Url.Action("AddComment", "StudentTaskTracking")',
                type: 'POST',
                data: { taskId: currentTaskId, content: commentText },
                success: function () {
                    $('#newComment').val(''); // Clear the textarea
                    loadPreviousComments(currentTaskId); // Reload comments
                },
                error: function () {
                    alert('Failed to add the comment.');
                }
            });
        }

        function editTask(taskId, sprintId) {
            var combinedId = taskId + '_' + sprintId;

            $.ajax({
                url: '@Url.Action("EditTask", "StudentTaskTracking")',
                type: 'POST',
                data: { taskInfo: combinedId },
                success: function (response) {
                    console.log("AJAX Response:", response); // Debug output
                    if (response.success) {
                        // Remove existing modal if present
                        $('#editTaskModal').remove();

                        // Initialize an empty string for the table rows
                        var tableRowsHtml = '';

                        // Use a forEach loop to generate table rows
                        response.students.forEach(student => {
                            tableRowsHtml += `
                                        <tr>
                                            <td><input type="checkbox" name="SelectedStudentIds" value="${student.id}" ${student.isSelected ? 'checked' : ''} /></td>
                                            <td>${student.id}</td>
                                            <td>${student.studentId}</td>
                                            <td>${student.givenName}</td>
                                            <td>${student.surname}</td>
                                            <td>${student.email}</td>
                                        </tr>`;
                        });
                        // Generate sprint options HTML
                        var sprintOptionsHtml = response.sprintOptions.map(sprint => `
                                    <option value="${sprint.id}" ${sprint.isSelected ? 'selected' : ''}>${sprint.sprintName}</option>
                                `).join('');
                        // Dynamically create the modal HTML
                        var modalHtml = `
                                <div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <form method="post" action="@Url.Action("UpdateTask", "StudentTaskTracking")" id="editTaskForm">
                                                <input type="hidden" name="__RequestVerificationToken" value="${$('input[name="__RequestVerificationToken"]').val()}" />
                                                <input type="hidden" name="TaskId" value="${response.taskId}" />
                                                <input type="hidden" name="SprintId" value="${response.sprintId}" />
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                  <h5>Select Sprint</h5>
                                                    <div class="form-group">
                                                        <label for="sprintSelect">Sprint</label>
                                                        <select class="form-control" id="sprintSelect" name="SprintId" required>
                                                            ${sprintOptionsHtml}
                                                        </select>
                                                    </div>
                                                    <h5>Select Students to Assign Task</h5>
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>Select</th>
                                                                <th>Id</th>
                                                                <th>Student ID</th>
                                                                <th>Given Name</th>
                                                                <th>Surname</th>
                                                                <th>Email</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${tableRowsHtml}
                                                        </tbody>
                                                    </table>

                                                    <div class="form-group">
                                                        <label for="selectedStatus">Status</label>
                                                        <select class="form-control" id="selectedStatus" name="SelectedStatus" required>
                                                            <option value="">-- Select Status --</option>
                                                            ${response.statusOptions.map(status => `
                                                                <option value="${status.value}" ${status.value === response.selectedStatus ? 'selected' : ''}>${status.text}</option>
                                                            `).join('')}
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="taskName">Task Name</label>
                                                        <input type="text" class="form-control" id="taskName" name="TaskName" required value="${response.taskName}" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="taskDescription">Description</label>
                                                        <textarea class="form-control" id="taskDescription" name="TaskDescription" rows="3" required>${response.taskDescription}</textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Priority</label><br />
                                                        ${response.priorityOptions.map(priority => `
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input" type="radio" name="SelectedPriority" id="priority_${priority.value}" value="${priority.value}" ${priority.value === response.selectedPriority ? 'checked' : ''} required>
                                                                <label class="form-check-label" for="priority_${priority.value}">${priority.text}</label>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                    <div class="form-row">
                                                        <div class="form-group col-md-6">
                                                            <label for="taskStartDate">Start Date</label>
                                                            <input type="datetime-local" class="form-control" id="taskStartDate" name="TaskStartDate" value="${response.taskStartDate}" required />
                                                        </div>
                                                        <div class="form-group col-md-6">
                                                            <label for="taskEndDate">End Date</label>
                                                            <input type="datetime-local" class="form-control" id="taskEndDate" name="TaskEndDate" value="${response.taskEndDate}" required />
                                                        </div>
                                                    </div>
                                                    <div id="modalError" class="text-danger"></div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Clear</button>
                                                    <button type="submit" class="btn btn-primary">Submit</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>`;

                        // Append the modal to the body
                        $('body').append(modalHtml);

                        // Show the modal
                        $('#editTaskModal').modal('show');
                    } else {
                        alert(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        }

</script>
}

